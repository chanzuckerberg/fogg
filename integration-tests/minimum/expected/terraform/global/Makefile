# Auto-generated by fogg. Do not edit
# Make improvements in fogg, so that everyone can benefit.

TF_VARS := $(patsubst %,-e%,$(filter TF_VAR_%,$(.VARIABLES)))
REPO_ROOT := $(shell git rev-parse --show-toplevel)
REPO_RELATIVE_PATH := $(shell git rev-parse --show-prefix)
# We need to do this because `terraform fmt` recurses into .terraform/modules
# and wont' accept more than one file at a time.
TF=$(wildcard *.tf)

docker_base = \
	docker run -it --rm -e HOME=/home -v $$HOME/.aws:/home/.aws -v $(REPO_ROOT):/repo \
	-e GIT_SSH_COMMAND='ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no' \
	-e TF_PLUGIN_CACHE_DIR="/repo/.terraform.d/plugin-cache" -e TF="$(TF)" \
	-w /repo/$(REPO_RELATIVE_PATH) $(TF_VARS) $$($(REPO_ROOT)/scripts/docker-ssh-mount.sh)
docker_terraform = $(docker_base) chanzuckerberg/terraform:0.1000.0
docker_sh = $(docker_base) --entrypoint='/bin/sh' chanzuckerberg/terraform:0.1000.0

all:

fmt:
	@$(docker_sh) -c 'for f in $(TF); do printf .; terraform fmt $$f; done'; \
	echo

lint: lint-tf

lint-tf:
	@$(docker_sh) -c 'for f in $(TF); do printf .; terraform fmt --check=true --diff=true $$f || exit $$? ; done'; \
	echo

get: ssh-forward
	$(docker_terraform) get --update=true

plan: fmt get init ssh-forward
	$(docker_terraform) plan

apply: fmt get init ssh-forward
	$(docker_terraform) apply -auto-approve=false

docs:
	@echo

clean:
	-rm -rfv .terraform/modules
	-rm -rfv .terraform/plugins

test:

init: ssh-forward
	$(docker_terraform) init -input=false

check-plan: init get ssh-forward
	$(docker_terraform) plan -detailed-exitcode; \
	ERR=$$?; \
	if [ $$ERR -eq 0 ] ; then \
		echo "Success"; \
	elif [ $$ERR -eq 1 ] ; then \
		echo "Error in plan execution."; \
		exit 1; \
	elif [ $$ERR -eq 2 ] ; then \
		echo "Diff";  \
	fi

ssh-forward:
	$(REPO_ROOT)/scripts/docker-ssh-forward.sh

run:
	$(docker_terraform) $(CMD)

.PHONY: all apply clean docs fmt get lint plan run ssh-forward test
