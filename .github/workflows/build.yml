
on: push

jobs:
  test:
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-go@v2
        with:
          go-version: '1.14.0'
      - run: go version
      - name: Setup buildevents
        uses: kvrhdn/gha-buildevents@master
        with:
          apikey: ${{ secrets.BUILDEVENTS_APIKEY }}
          dataset: buildevents
          # Required: the job status, this will be used in the post section and sent
          # as status of the trace. Must always be ${{ job.status }}.
          job-status: ${{ job.status }}

      - run: |
          echo ::set-env name=STEP_START::$(date +%s)
          echo ::set-env name=STEP_ID::$(echo install | sum | cut -f 1 -d \ )
      - name: Install dependencies
        run: |
          buildevents cmd $TRACE_ID $STEP_ID make-setup -- make setup
          buildevents step $TRACE_ID $STEP_ID $STEP_START install

      - run: |
          echo ::set-env name=STEP_START::$(date +%s)
          echo ::set-env name=STEP_ID::$(echo script | sum | cut -f 1 -d \ )
      - name: Run tests
        run: |
          buildevents cmd $TRACE_ID $STEP_ID codecov-validate -- curl --data-binary @codecov.yml https://codecov.io/validate
          buildevents cmd $TRACE_ID $STEP_ID make-lint-ci -- make lint-ci
          buildevents cmd $TRACE_ID $STEP_ID make-test-ci -- make test-ci
          buildevents step $TRACE_ID $STEP_ID $STEP_START script

      - run: |
          echo ::set-env name=STEP_START::$(date +%s)
          echo ::set-env name=STEP_ID::$(echo after_success | sum | cut -f 1 -d \ )
      - name: Run codecov
        run:
          buildevents cmd $TRACE_ID $STEP_ID codecov-upload -- bash <(curl -s https://codecov.io/bash)
          buildevents step $TRACE_ID $STEP_ID $STEP_START after_success
  # Disabling snyk - had to cancel run after waiting over an hour. Unreasonable run time also seen when running
  # snyk/snyk:golang image locally on laptop; Docker image appears broken.
  # snyk:
  #   # Must be run separately from main tests, because actions/setup-go sets the GOROOT env, which messes up
  #   # the snyk container.
  #   runs-on: ubuntu-18.04
  #   steps:
  #     - uses: actions/checkout@v2
  #     - name: Run Snyk to check for vulnerabilities
  #       uses: snyk/actions/golang@master
  #       env:
  #         SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
  #       with:
  #         args: --org=czi
  #     - name: Run Snyk to continuously monitor for vulnerabilities
  #       uses: snyk/actions/golang@master
  #       env:
  #         SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
  #       with:
  #         command: monitor
  #         args: --org=czi
