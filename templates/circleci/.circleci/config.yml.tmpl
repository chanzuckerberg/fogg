version: 2.1

working_directory: &working_directory ~/fogg
cache_key: &cache_key v1-fogg-{{ `{{ .Revision }}` }}

commands:
  config_aws_source_profile:
    description: Configure the AWS source profile
    steps:
      - run: aws configure set aws_access_key_id $IDACCT_AWS_ACCESS_KEY_ID --profile _idacct
      - run: aws configure set aws_secret_access_key $IDACCT_AWS_SECRET_ACCESS_KEY --profile _idacct
      # - run: aws --profile _idacct sts get-caller-identity
  config_aws_profile:
    description: Configure AWS authentication
    parameters:
      profile_name:
        type: string
      aws_account_id:
        type: string
      role_name:
        type: string
    steps:
      - run: aws configure set profile.<< parameters.profile_name >>.role_arn arn:aws:iam::<< parameters.aws_account_id>>:role/<< parameters.role_name >>
      - run: aws configure set profile.<< parameters.profile_name >>.source_profile _idacct
      # - run: aws sts get-caller-identity --profile << parameters.profile_name >>
  terraform_test:
    description: Test a terraform component
    parameters:
      dir:
        type: string
      command:
        type: string
        default: check
    steps:
      - run: cd << parameters.dir >>
      - run: make << parameters.command >>
executors:
  python:
    docker:
      - image: circleci/python:3.8

jobs:
  dependencies:
    executor: python
    working_directory: *working_directory
    steps:
      - checkout
      - run: pip install awscli --upgrade --user
      - run: aws --version
      - config_aws_source_profile
      - run: FOGG_VERSION="v0.34.1" make setup
      - save_cache:
          key: *cache_key
          paths:
            - ~/.aws
            - .fogg
  terraform-test:
    executor: python
    steps:
      - checkout
      - restore_cache:
          keys:
            - *cache_key
      - run: ls -la
      - run: cat ~/.aws/*
workflows:
  version: 2.1
  test:
    jobs:
      - dependencies
      - terraform-test:
          requires:
            - dependencies
