# Auto-generated by fogg. Do not edit
# Make improvements in fogg, so that everyone can benefit.
{{- $githubActionsCI := . }}

on: pull_request

concurrency:
  group: {{`${{ github.ref }}`}}

jobs:
  fogg-apply:
    runs-on: ubuntu-latest
    {{- if not (eq (len $githubActionsCI.DefaultAWSIAMRoleName) 0) }}
    permissions:
      # required for GH Actions -> OIDC -> AWS
      id-token: write
      contents: read
    {{- end }}
    steps:
      - uses: actions/checkout@v4.1.0
        with:
          repository: {{`${{ github.event.pull_request.head.repo.full_name }}`}}
          ref: {{`${{ github.event.pull_request.head.ref }}`}}
      - name: Cache Fogg
        id: cache-fogg
        uses: actions/cache@v3
        with:
          path: ~/.fogg/cache
          key: fogg-cache-{{`${{ hashFiles('**/.fogg-version') }}`}}
      - run: |
          make setup
          echo "$(pwd)/.fogg/bin" >> "${GITHUB_PATH}"
      {{- if not (eq (len $githubActionsCI.DefaultAWSIAMRoleName) 0) }}
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4.0.1
        with:
          role-to-assume: {{ $githubActionsCI.DefaultAWSIAMRoleName }}
          aws-region: {{ $githubActionsCI.DefaultAWSRegion }}
      {{- end }}
      {{- if $githubActionsCI.PreCommit.Enabled }}
      - name: Set up pre-commit
        uses: ./.github/actions/setup-pre-commit
        with:
          requirements: ./requirements.txt
      {{- if not (eq (len $githubActionsCI.PreCommit.GitHubActionSteps) 0) }}
      {{- toYaml $githubActionsCI.PreCommit.GitHubActionSteps | nindent 6 }}
      {{- end }}
      # run fogg apply and selected pre-commit autofixers (ignore any errors)
      - run: fogg apply && make pre-commit
        env:
          FOGG_GITHUBTOKEN: {{`${{ secrets.GITHUB_TOKEN }}`}}
      # run full pre-commit
      - run: {{ list "pre-commit run --show-diff-on-failure --color=always" ($githubActionsCI.PreCommit.ExtraArgs | join " ") | join " " }}
      {{- else }}
      - run: fogg apply
        env:
          FOGG_GITHUBTOKEN: {{`${{ secrets.GITHUB_TOKEN }}`}}
      # Run git diff and fail if it returns a non-zero exit code
      - name: Ensure no git diff
        run: git diff --exit-code
      {{- end }}
