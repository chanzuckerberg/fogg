#!/usr/bin/env ruby

# Auto-generated by fogg. Do not edit
# Make improvements in fogg, so that everyone can benefit.

require 'json'
require 'pp'

puts "What is the absolute path to your blessclient?"
blessclientPath = gets

puts "What remote user are you using?"
remoteUser = gets

ENVS = %w[{{ .Envs | dict | keys | sortAlpha | join " "}}]

d = ENVS.map do |env|
    outputs = `cd terraform/envs/#{env}/cloud-env && terraform output -json`
    begin
        data = JSON.parse(outputs)
        cidr = data['vpc_cidr']['value']
        address, prefix_length = cidr.split('/')
        pattern =  address.split('.')[0..((prefix_length.to_i/8)-1)].join('.') + '.*'
        bastion = data['bastion_fqdn']['value']
        [pattern, bastion]
    rescue JSON::ParserError => e
        puts "Error generating config for env: '#{env}'. Output of terraform json request: \n#{outputs}"
    end
end

d.each do |(pattern, bastion)|
    print <<-END

Match OriginalHost #{bastion} exec "#{blessclientPath} --gui --region west --host '%h'"
  IdentityFile ~/.ssh/blessid

Host #{pattern}
  ProxyJump #{bastion}
  User #{remoteUser}

Host #{bastion}
  User #{remoteUser}

END
end
