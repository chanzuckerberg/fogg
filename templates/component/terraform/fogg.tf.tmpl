# Auto-generated by fogg. Do not edit
# Make improvements in fogg, so that everyone can benefit.

{{ if .ProviderConfiguration.AWS }}
{{ template "aws_provider" .ProviderConfiguration.AWS}}
  # Aliased Providers (for doing things in every region).
  {{ range $p := .ProviderConfiguration.AWSAdditionalProviders }}
    {{ template "aws_provider" $p}}
  {{ end }}

{{ end }}

{{ if .ProviderConfiguration.Snowflake }}
  {{ template "snowflake_provider" .ProviderConfiguration.Snowflake }}
{{ end }}

{{ if .ProviderConfiguration.Bless }}
  {{ template "bless_provider" .ProviderConfiguration.Bless }}
{{ end }}

{{ if .ProviderConfiguration.Okta}}
  {{ template "okta_provider" .ProviderConfiguration.Okta}}
{{ end }}

{{ if .ProviderConfiguration.Github}}
  {{ template "github_provider" .ProviderConfiguration.Github}}
{{ end }}

{{ if .ProviderConfiguration.Heroku }}
  {{ template "heroku_provider" .ProviderConfiguration.Heroku }}
{{ end }}

{{ if .ProviderConfiguration.Datadog }}
  {{ template "datadog_provider" .ProviderConfiguration.Datadog }}
{{ end }}

{{ if .ProviderConfiguration.Tfe }}{{ if .ProviderConfiguration.Tfe.Enabled }}
    {{ template "tfe_provider" .ProviderConfiguration.Tfe }}
{{ end }}{{ end }}


terraform {
  required_version = "={{ .TerraformVersion }}"

  {{ template "backend" .Backend }}

  required_providers {

  {{ if .ProviderConfiguration.AWS }}
    aws = {
      source = "hashicorp/aws"
      version = "{{ .ProviderConfiguration.AWS.Version }}"
    }
  {{ end }}

  {{ if .ProviderConfiguration.Snowflake }}
      snowflake = {
        source = "chanzuckerberg/snowflake"
        {{ if .ProviderConfiguration.Snowflake.Version -}}
        version = "{{ .ProviderConfiguration.Snowflake.Version }}"
        {{ end -}}
      }
  {{ end }}

  {{ if .ProviderConfiguration.Bless }}
    bless = {
      source = "chanzuckerberg/bless"
      version = "{{ .ProviderConfiguration.Bless.Version }}"
    }
  {{ end }}

  {{ if .ProviderConfiguration.Okta}}
    okta = {
      source = "oktadeveloper/okta"
      version = "{{ .ProviderConfiguration.Okta.Version }}"
    }
  {{ end }}

  {{ if .ProviderConfiguration.Github}}
    githhb = {
      source = "integrations/github"
      version = "{{ .ProviderConfiguration.Github.Version }}"
    }
  {{ end }}

  {{ if .ProviderConfiguration.Heroku }}
      heroku = {
      source = "heroku/heroku"
      version = "{{ .ProviderConfiguration.Heroku.Version }}"
    }
  {{ end }}

  {{ if .ProviderConfiguration.Datadog }}
    datadog = {
      source = "datadog/datadog"
      version = "{{ .ProviderConfiguration.Datadog.Version }}"
    }
  {{ end }}

  {{ if .ProviderConfiguration.Sentry }}
    sentry = {
      source = "jianyuan/sentry"
      version = "{{ .ProviderConfiguration.Sentry.Version }}"
    }
  {{ end }}

  {{ if .ProviderConfiguration.Tfe }}{{ if .ProviderConfiguration.Tfe.Enabled }}
    tfe = {
      source = "hashicorp/tfe"
      version = "{{ .ProviderConfiguration.Tfe.Version }}"
    }
  {{ end }}{{ end }}

  {{ if .ProviderConfiguration.Kubernetes }}{{ if .ProviderConfiguration.Kubernetes.Enabled }}
    kubernetes = {
      source = "hashicorp/kubernetes"
      version = "{{ .ProviderConfiguration.Kubernetes.Version }}"
    }
  {{ end }}{{ end }}

    random = {
      source="hashicorp/random"
      version = "~> 2.2"
    }

    template = {
    source="hashicorp/template"
      version = "~> 2.2"
    }

    archive = {
    source="hashicorp/archive"
      version = "~> 2.0"
    }

    null = {
    source="hashicorp/null"
      version = "~> 3.0"
    }

    local = {
    source="hashicorp/local"
      version = "~> 2.0"
    }

    tls = {
    source="hashicorp/tls"
      version = "~> 3.0"
    }
  }
}

variable env {
  type    =  string
  default = "{{ .Env }}"
}

variable project {
  type    =  string
  default = "{{ .Project }}"
}

{{if .ProviderConfiguration.AWS}}
  variable region {
    type    =  string
    default = "{{ .ProviderConfiguration.AWS.Region }}"
  }
{{ end }}

variable component {
  type =  string
  default = "{{ .Name }}"
}

{{ if (avail "Account" .) }}
variable account {
  type =  string
  default = "{{ .Account }}"
}
{{ end }}

{{ if .ProviderConfiguration.AWS }}{{ if .ProviderConfiguration.AWS.Profile }}
  variable aws_profile {
    type =  string
    default =  "{{ .ProviderConfiguration.AWS.Profile }}"
  }
{{ end }}{{ end }}

variable owner {
  type =  string
  default = "{{ .Owner }}"
}

variable tags {
  type =  object({project: string, env: string, service: string, owner: string, managedBy: string})
  default = {
    project   = "{{ .Project }}"
    env       = "{{ .Env }}"
    service   = "{{ .Name }}"
    owner     = "{{ .Owner }}"
    managedBy = "terraform"
  }
}

{{ range $key, $val := .ExtraVars }}
variable {{ $key }} {
  type =  string
  default = "{{ $val }}"
}
{{ end }}

{{ if .Global }}
data terraform_remote_state global {
  backend = "{{ .Global.Backend.Kind }}"

  config = {
    {{ template "remote_backend" .Global.Backend }}
  }
}
{{ end }}

{{ $outer := . }}
{{ range $component, $backend := .ComponentBackends  }}
{{ if ne $component $outer.Name }}
data terraform_remote_state {{ $component }} {
  backend = "{{ $backend.Kind }}"

  config = {
      {{ template "remote_backend" $backend }}
  }
}
{{ end }}
{{ end }}

{{ range $name, $backend := .AccountBackends }}
data terraform_remote_state {{ $name }} {
  backend = "{{ $backend.Kind }}"

  config = {
    {{ template "remote_backend" $backend }}
  }
}
{{ end }}

variable aws_accounts {
  type =  map
  default = {
  {{ range $account, $id := .Accounts }}
    {{ $account }} = {{ $id }}
  {{ end }}
  }
}

{{ template "common_providers" }}
