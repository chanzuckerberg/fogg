# Auto-generated by fogg. Do not edit
# Make improvements in fogg, so that everyone can benefit.

{{ if .Providers.AWS }}
  provider "aws" {
    version = "~> {{ .Providers.AWS.Version }}"
    region = "{{ .Providers.AWS.Region }}"
    profile = "{{ .Providers.AWS.Profile }}"
    allowed_account_ids = [{{ .Providers.AWS.AccountID }}]
  }

  # Aliased Providers (for doing things in every region).
  {{ $outer := . }}
  {{ range $region := .Providers.AWS.AdditionalRegions }}
    provider "aws" {
      alias = "{{ $region }}"
      version = "~> {{ $outer.Providers.AWS.Version }}"
      region = "{{ $region }}"
      profile = "{{ $outer.Providers.AWS.Profile }}"
      allowed_account_ids = [{{ $outer.Providers.AWS.AccountID }}]
    }
  {{ end }}

{{ end }}

{{ if .Providers.Snowflake }}
  {{ template "snowflake_provider" .Providers.Snowflake }}
{{ end }}

{{ if .Providers.Bless }}
  {{ template "bless_provider" .Providers.Bless }}
{{ end }}

{{ if .Providers.Okta}}
  {{ template "okta_provider" .Providers.Okta}}
{{ end }}

{{ if .Providers.Github}}
  {{ template "github_provider" .Providers.Github}}
{{ end }}

{{ if .Providers.Heroku }}
  {{ template "heroku_provider" .Providers.Heroku }}
{{ end }}

{{ if .Providers.Datadog }}
  {{ template "datadog_provider" .Providers.Datadog }}
{{ end }}

terraform {
  required_version = "~>{{ .TerraformVersion }}"

  backend "s3" {
    bucket         = "{{ .Backend.S3.Bucket }}"
    {{ if .Backend.S3.DynamoTable }}dynamodb_table = "{{ .Backend.S3.DynamoTable }}"{{ end }}
    {{/* {%- if env is defined and component_name is defined %} */}}
    key            = "terraform/{{ .Project }}/envs/{{ .Env }}/components/{{ .Component }}.tfstate"

{{/*
    {%- else %}
    key    = "terraform/{{ project }}/global.tfstate"
    {%- endif %}
*/}}
    encrypt = true
    region = "{{ .Backend.S3.Region }}"
    profile = "{{ .Backend.S3.Profile }}"
  }
}

variable "env" {
  type    =  string
  default = "{{ .Env }}"
}

variable "project" {
  type    =  string
  default = "{{ .Project }}"
}

{{if .Providers.AWS}}
  variable "region" {
    type    =  string
    default = "{{ .Providers.AWS.Region }}"
  }
{{ end }}

variable "component" {
  type =  string
  default = "{{ .Component }}"
}

{{if .Providers.AWS}}
  variable "aws_profile" {
    type =  string
    default =  "{{ .Providers.AWS.Profile }}"
  }
{{ end }}


variable "owner" {
  type =  string
  default = "{{ .Owner }}"
}

variable "tags" {
  type =  map(string)
  default = {
    project   = "{{ .Project }}"
    env       = "{{ .Env }}"
    service   = "{{ .Component }}"
    owner     = "{{ .Owner }}"
    managedBy = "terraform"
  }
}

{{ range $key, $val := .ExtraVars }}
variable "{{ $key }}" {
  type =  string
  default = "{{ $val }}"
}
{{ end }}

data "terraform_remote_state" "global" {
  backend = "s3"

  config = {
    bucket         = "{{ .Global.Backend.S3.Bucket }}"
    {{ if .Backend.S3.DynamoTable }}dynamodb_table = "{{ .Global.Backend.S3.DynamoTable }}"{{ end }}
    key            = "terraform/{{ .Global.Project }}/global.tfstate"
    region         = "{{ .Global.Backend.S3.Region }}"
    {{ if .Global.Backend.S3.Profile }}profile        = "{{ .Global.Backend.S3.Profile }}"{{ end }}
  }
}

{{ $outer := . }}
{{ range $component := .OtherComponents | sortAlpha  }}
data "terraform_remote_state" "{{ $component }}" {
  backend = "s3"

  config = {
    bucket         = "{{ $outer.Backend.S3.Bucket }}"
    {{ if $outer.Backend.S3.DynamoTable }}dynamodb_table = "{{ $outer.Backend.S3.DynamoTable }}"{{ end }}
    key            = "terraform/{{ $outer.Project }}/envs/{{ $outer.Env }}/components/{{ $component }}.tfstate"
    region         = "{{ $outer.Backend.S3.Region }}"
    {{ if $outer.Backend.S3.Profile }}profile        = "{{ $outer.Backend.S3.Profile }}"{{ end }}
  }
}
{{ end }}

# remote state for accounts
{{ range $accountName, $account := .Accounts }}
data "terraform_remote_state" "{{ $accountName }}" {
  backend = "s3"

  config = {
    bucket         = "{{ $account.Backend.S3.Bucket }}"
    {{ if $account.Backend.S3.DynamoTable }}dynamodb_table = "{{ $account.Backend.S3.DynamoTable }}"{{ end }}
    key            = "terraform/{{ .Project }}/accounts/{{ $account.AccountName }}.tfstate"
    region         = "{{ $account.Backend.S3.Region }}"
    {{ if $account.Backend.S3.Profile }}profile        = "{{ $account.Backend.S3.Profile }}"{{ end }}
  }
}
{{ end }}

# map of aws_accounts
variable "aws_accounts" {
  type =  map
  default = {
  {{ range $accountName, $account := .Accounts }}
    {{ if $account.Providers.AWS }}
        {{ $accountName }} = {{ $account.Providers.AWS.AccountID }}
    {{ end }}
  {{ end }}
  }
}

{{ template "common_providers" }}
