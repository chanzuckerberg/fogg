# Auto-generated by fogg. Do not edit
# Make improvements in fogg, so that everyone can benefit.
language: python
sudo: required
python: 3.6

install:
  - pip install awscli --upgrade
  - aws --version
  - curl -o download.sh -s https://raw.githubusercontent.com/chanzuckerberg/fogg/master/download.sh
  - travis_retry bash download.sh -b $HOME/bin v{{ .FoggVersion }}
  - travis_retry fogg setup
before_script:
  # TODO add note about why these need to be prefixed with HUB_
  - aws configure set aws_access_key_id     $IDACCT_AWS_ACCESS_KEY_ID     --profile _idacct
  - aws configure set aws_secret_access_key $IDACCT_AWS_SECRET_ACCESS_KEY --profile _idacct
  - aws --profile _idacct sts get-caller-identity

{{ range $profileName, $profile:= .AWSProfiles}}
  - aws configure set profile.{{ $profileName }}.role_arn arn:aws:iam::{{ $profile.AccountID }}:role/{{ $profile.RoleName}}
  - aws configure set profile.{{ $profileName }}.source_profile _idacct
  - aws --profile {{ $profileName }} sts get-caller-identity
{{ end }}

jobs:
  include:
    - stage: check
      script:
        - |
        set -e
        fogg apply
        if [ "$(git status --porcelain)" != "" ]; then
          echo "git tree is dirty after running fogg apply"
          echo "ensure you run fogg apply on your branch"
          git status
          exit 1
        fi
{{ range $testBucket := .TestBuckets }}
    - stage: check
      script:
        - set -e
      {{- range $component := $testBucket }}
        - pushd {{ $component.Dir }} && travis_retry make {{ $component.Command }} && popd
      {{- end -}}
{{ end }}
