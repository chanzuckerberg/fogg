# Auto-generated by fogg. Do not edit
# Make improvements in fogg, so that everyone can benefit.
language: python
sudo: required
python: 3.6

install:
  - pip install awscli --upgrade
  - aws --version
  - curl -o download.sh -s https://raw.githubusercontent.com/chanzuckerberg/fogg/master/download.sh
  - travis_retry bash download.sh -b $HOME/bin vundefined+undefined+dirty
  - rm download.sh
  - travis_retry fogg setup
before_script:
  # TODO add note about why these need to be prefixed with HUB_
  - aws configure set aws_access_key_id     $IDACCT_AWS_ACCESS_KEY_ID     --profile _idacct
  - aws configure set aws_secret_access_key $IDACCT_AWS_SECRET_ACCESS_KEY --profile _idacct
  - aws --profile _idacct sts get-caller-identity


  - aws configure set profile.czi-bar.role_arn arn:aws:iam::3:role/travis-role
  - aws configure set profile.czi-bar.source_profile _idacct
  - aws --profile czi-bar sts get-caller-identity

  - aws configure set profile.czi-env.role_arn arn:aws:iam::5:role/travis-role
  - aws configure set profile.czi-env.source_profile _idacct
  - aws --profile czi-env sts get-caller-identity

  - aws configure set profile.czi-foo.role_arn arn:aws:iam::2:role/travis-role
  - aws configure set profile.czi-foo.source_profile _idacct
  - aws --profile czi-foo sts get-caller-identity

  - aws configure set profile.czi-stage.role_arn arn:aws:iam::4:role/travis-role
  - aws configure set profile.czi-stage.source_profile _idacct
  - aws --profile czi-stage sts get-caller-identity


jobs:
  include:
    - stage: fogg-apply clean
      script:
        - |
          set -e
          fogg apply
          if [ "$(git status --porcelain)" != "" ]; then
            echo "git tree is dirty after running fogg apply"
            echo "ensure you run fogg apply on your branch"
            git status
            exit 1
          fi

    - stage: check
      script:
        - set -e
        - pushd terraform/accounts/bar && travis_retry make check && popd
    - stage: check
      script:
        - set -e
        - pushd terraform/accounts/foo && travis_retry make check && popd
    - stage: check
      script:
        - set -e
        - pushd terraform/global && travis_retry make check && popd
    - stage: check
      script:
        - set -e
        - pushd terraform/modules/module1 && travis_retry make check && popd
    - stage: check
      script:
        - set -e
        - pushd terraform/envs/stage/cloud-env && travis_retry make check && popd
    - stage: check
      script:
        - set -e
        - pushd terraform/envs/stage/helm && travis_retry make check && popd
    - stage: check
      script:
        - set -e
    - stage: check
      script:
        - set -e
    - stage: check
      script:
        - set -e
    - stage: check
      script:
        - set -e
    - stage: check
      script:
        - set -e
    - stage: check
      script:
        - set -e
    - stage: check
      script:
        - set -e
