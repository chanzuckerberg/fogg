# Auto-generated by fogg. Do not edit
# Make improvements in fogg, so that everyone can benefit.

on:
  push:
  merge_group:

concurrency:
  group: ${{ github.ref }}

jobs:
  fogg-apply:
    runs-on: [self-hosted,ARM64]
    steps:
      - name: Generate token
        id: generate_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.CZI_GITHUB_HELPER_APP_ID }}
          private_key: ${{ secrets.CZI_GITHUB_HELPER_PK }}
      - uses: actions/checkout@v3
        with:
          token: ${{ steps.generate_token.outputs.token }}
      - name: Cache Fogg
        id: cache-fogg
        uses: actions/cache@v3
        with:
          path: ~/.fogg/cache
          key: fogg-cache-${{ hashFiles('**/.fogg-version') }}
      - run: make setup
      - run: |
          mkdir -p ~/.ssh/
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts
      - run: .fogg/bin/fogg apply
        env:
          FOGG_GITHUBAPPTOKEN: ${{ steps.generate_token.outputs.token }}
      - uses: EndBug/add-and-commit@v9
        with:
          add: -A
          message: |
            commit from fogg_ci -- ran fogg apply and pushed
  find-changed-dirs:
    runs-on: [self-hosted,ARM64]
    outputs:
      allChanges: ${{ steps.changedDirs.outputs.allChanges }}
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2.10.2
        id: filter
        with:
          initial-fetch-depth: '1'
          list-files: json
          filters: |
            changed:
              - added|modified: 'terraform/**'
      - uses: actions/github-script@v6
        id: changedDirs
        with:
          script: |
            const path = require("path")
            const changedFiles = ${{ steps.filter.outputs.changed_files }}
            const changedDirs = changedFiles.map(f => path.dirname(f))
            console.log(`Found the following changed dirs: ${JSON.stringify(changedDirs, null, 2)}\n OG: ${JSON.stringify(changedFiles, null, 2)} `)
            const changedModules = [... new Set(changedDirs.filter(d => d.indexOf("modules") !== -1 && d.split("/").length === 3))]
            const changedAccounts = [... new Set(changedDirs.filter(d => d.indexOf("accounts") !== -1 && d.split("/").length === 3))]
            const changedEnvs = [... new Set(changedDirs.filter(d => d.indexOf("envs") !== -1 && d.split("/").length === 4))]
            const allChanges = [...changedAccounts,...changedEnvs, ...changedModules]
            console.log(`changedModules: ${JSON.stringify(changedModules)}`)
            console.log(`changedAccounts: ${JSON.stringify(changedAccounts)}`)
            console.log(`changedEnvs: ${JSON.stringify(changedEnvs)}`)
            core.setOutput("allChanges", allChanges)
  lint-changed-dirs:
    runs-on: [self-hosted,ARM64]
    needs: find-changed-dirs
    strategy:
      matrix:
        tfmodule: ${{ fromJson(needs.find-changed-dirs.outputs.allChanges) }}
    if: ${{ needs.find-changed-dirs.outputs.allChanges != '[]' }}
    steps:
      - name: Generate token
        id: generate_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.CZI_GITHUB_HELPER_APP_ID }}
          private_key: ${{ secrets.CZI_GITHUB_HELPER_PK }}
      - uses: actions/checkout@v3
        with:
          token: ${{ steps.generate_token.outputs.token }}
      - name: fix terraform docs
        uses: terraform-docs/gh-actions@v1.0.0
        if: contains(matrix.tfmodule, 'modules') # only need to make docs on the modules
        with:
          working-dir: ${{matrix.tfmodule}}
          git-push: "true"
          template: <!-- START -->\n{{ .Content }}\n<!-- END -->
          ref: ${{ github.event.pull_request.head.ref }}
          git-commit-message: |
            commit from fogg_ci -- ran terraform-docs and pushed
      - name: fix terraform fmt
        run: |
          cd ${{matrix.tfmodule}}
          make fmt
      - uses: EndBug/add-and-commit@v9
        with:
          add: -A
          message: |
            commit from fogg_ci -- ran terraform fmt and pushed
      - name: tflint
        run: |
          make setup
          cd ${{matrix.tfmodule}}
          ${GITHUB_WORKSPACE}/.fogg/bin/tflint --disable-rule terraform_deprecated_index --disable-rule terraform_required_providers --disable-rule terraform_unused_declarations
