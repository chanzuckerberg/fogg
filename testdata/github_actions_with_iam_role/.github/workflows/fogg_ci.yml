# Auto-generated by fogg. Do not edit
# Make improvements in fogg, so that everyone can benefit.

on: pull_request

concurrency:
  group: ${{ github.ref }}

jobs:
  fogg-apply:
    runs-on: ubuntu-latest
    permissions:
      # required for GH Actions -> OIDC -> AWS
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4.1.2
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
      - name: Cache Fogg
        id: cache-fogg
        uses: actions/cache@v4
        with:
          path: ~/.fogg/cache
          key: fogg-cache-${{ hashFiles('**/.fogg-version') }}
      - run: |
          make setup
          echo "$(pwd)/.fogg/bin" >> "${GITHUB_PATH}"
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          role-to-assume: infraci
          aws-region: us-east-1
      - run: fogg apply
        env:
          FOGG_GITHUBTOKEN: ${{ secrets.GITHUB_TOKEN }}
      # Run git diff and fail if it returns a non-zero exit code
      - name: Ensure no git diff
        run: git diff --exit-code
