# Auto-generated by fogg. Do not edit
# Make improvements in fogg, so that everyone can benefit.

on: pull_request

concurrency:
  group: ${{ github.ref }}

jobs:
  fogg-apply:
    runs-on: ubuntu-latest
    permissions:
      # required for GH Actions -> OIDC -> AWS
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4.1.0
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
      - name: Cache Fogg
        id: cache-fogg
        uses: actions/cache@v3
        with:
          path: ~/.fogg/cache
          key: fogg-cache-${{ hashFiles('**/.fogg-version') }}
      - run: |
          make setup
          echo "$(pwd)/.fogg/bin" >> "${GITHUB_PATH}"
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4.0.0
        with:
          role-to-assume: infraci
          aws-region: awsregion
      - name: Set up pre-commit
        uses: ./.github/actions/setup-pre-commit
        with:
          requirements: ./requirements.txt
      - uses: mfinelli/setup-shfmt@v2
        with:
          shfmt-version: 3.7.0
      - uses: lumaxis/shellcheck-problem-matchers@v2
      - name: Cache tflint plugin dir
        uses: actions/cache@v3
        with:
          key: tflint-${{ hashFiles('.tflint.hcl') }}
          path: ~/.tflint.d/plugins
      # run fogg apply and selected pre-commit autofixers (ignore any errors)
      - run: fogg apply && make pre-commit
        env:
          FOGG_GITHUBTOKEN: ${{ secrets.GITHUB_TOKEN }}
      # run full pre-commit
      - run: pre-commit run --show-diff-on-failure --color=always --all-files
