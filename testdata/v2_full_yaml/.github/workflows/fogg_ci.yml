# Auto-generated by fogg. Do not edit
# Make improvements in fogg, so that everyone can benefit.

on: pull_request

concurrency:
  group: ${{ github.ref }}

jobs:
  fogg-apply:
    runs-on: ubuntu-latest
    permissions:
      # required for GH Actions -> OIDC -> AWS
      id-token: write
      # required to push fixes back to repo
      contents: write
    steps:
      - uses: actions/checkout@v3
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
      - name: Cache Fogg
        id: cache-fogg
        uses: actions/cache@v3
        with:
          path: ~/.fogg/cache
          key: fogg-cache-${{ hashFiles('**/.fogg-version') }}
      - run: make setup
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: foo
          aws-region: bar
      - run: .fogg/bin/fogg apply
        env:
          FOGG_GITHUBTOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/setup-python@v3
      - uses: mfinelli/setup-shfmt@v1
        with:
          shfmt-version: 3.5.1
      - uses: rhythmictech/actions-setup-tfenv@v0.1.2
      - uses: scottbrenner/cfn-lint-action@v2
      - uses: pre-commit/action@v3.0.0
        with:
          extra_args: --all-files || true
      - uses: EndBug/add-and-commit@v9
        with:
          add: -A
          message: |
            commit from fogg_ci -- ran fogg apply and pushed
  find-changed-dirs:
    runs-on: ubuntu-latest
    outputs:
      allChanges: ${{ steps.changedDirs.outputs.allChanges }}
    steps:
      - uses: actions/checkout@v3
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
      - uses: dorny/paths-filter@v2.10.2
        id: filter
        with:
          initial-fetch-depth: '1'
          list-files: json
          filters: |
            changed:
              - added|modified: 'terraform/**'
      - uses: actions/github-script@v6
        id: changedDirs
        with:
          script: |
            const path = require("path")
            const changedFiles = ${{ steps.filter.outputs.changed_files }}
            const changedDirs = changedFiles.map(f => path.dirname(f))
            console.log(`Found the following changed dirs: ${JSON.stringify(changedDirs, null, 2)}\n OG: ${JSON.stringify(changedFiles, null, 2)} `)
            const changedModules = [... new Set(changedDirs.filter(d => d.indexOf("modules") !== -1 && d.split("/").length === 3))]
            const changedAccounts = [... new Set(changedDirs.filter(d => d.indexOf("accounts") !== -1 && d.split("/").length === 3))]
            const changedEnvs = [... new Set(changedDirs.filter(d => d.indexOf("envs") !== -1 && d.split("/").length === 4))]
            const allChanges = [...changedAccounts,...changedEnvs, ...changedModules]
            console.log(`changedModules: ${JSON.stringify(changedModules)}`)
            console.log(`changedAccounts: ${JSON.stringify(changedAccounts)}`)
            console.log(`changedEnvs: ${JSON.stringify(changedEnvs)}`)
            core.setOutput("allChanges", allChanges)
  lint-changed-dirs:
    runs-on: ubuntu-latest
    needs: find-changed-dirs
    strategy:
      matrix:
        tfmodule: ${{ fromJson(needs.find-changed-dirs.outputs.allChanges) }}
    if: ${{ needs.find-changed-dirs.outputs.allChanges != '[]' }}
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
      - name: fix terraform docs
        uses: terraform-docs/gh-actions@v1.0.0
        if: contains(matrix.tfmodule, 'modules') # only need to make docs on the modules
        with:
          working-dir: ${{matrix.tfmodule}}
          git-push: "true"
          template: <!-- START -->\n{{ .Content }}\n<!-- END -->
          ref: ${{ github.event.pull_request.head.ref }}
          git-commit-message: |
            commit from fogg_ci -- ran terraform-docs and pushed
      - name: fix terraform fmt
        run: |
          pushd ${{matrix.tfmodule}}
          make fmt
          popd
          git checkout .terraform-version
      - uses: EndBug/add-and-commit@v9
        with:
          add: -A
          message: |
            commit from fogg_ci -- ran terraform fmt and pushed
      - uses: actions/cache@v2
        name: Cache plugin dir
        with:
          path: ~/.tflint.d/plugins
          key: tflint-${{ hashFiles('.tflint.hcl') }}
      - uses: terraform-linters/setup-tflint@v2
        name: Setup TFLint
        with:
          tflint_version: v0.47.0
      - name: Init TFLint
        run: tflint --init
      - name: tflint
        run: |
          tflint --chdir ${{matrix.tfmodule}}
